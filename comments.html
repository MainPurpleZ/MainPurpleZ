<!-- comments.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Комментарии</title>
    <!-- Markdown Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg: #ffffff;
            --border-color: #ddd;
            --link-color: #0056b3;
            --button-bg: #0056b3;
            --button-hover-bg: #003d82;
            --button-text-color: white;
            --pinned-bg: #fffbe6;
            --pinned-border: #f0ad4e;
            --code-bg: #e8e8e8;
            --modal-overlay-bg: rgba(0,0,0,0.6);
        }
        .dark-theme {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --container-bg: #1e1e1e;
            --border-color: #444;
            --link-color: #90caf9;
            --button-bg: #90caf9;
            --button-hover-bg: #77a9d1;
            --button-text-color: #1e1e1e;
            --pinned-bg: #2a2a20;
            --pinned-border: #8a6d3b;
            --code-bg: #2a2a2a;
        }
        body { font-family: "Times New Roman", Times, serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 2em; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--container-bg); padding: 2em; border: 1px solid var(--border-color); }
        nav { padding-bottom: 1em; border-bottom: 1px solid var(--border-color); margin-bottom: 2em; display: flex; align-items: center; flex-wrap: wrap; }
        nav a { margin-right: 20px; color: var(--link-color); text-decoration: none; font-size: 1.1em; }
        .auth-links { margin-left: auto; display: flex; align-items: center; }
        #logoutBtn { background: none; border: none; color: #d9534f; cursor: pointer; font-size: 1.1em; font-family: "Times New Roman", Times, serif; }
        #theme-toggle { background: none; border: 1px solid var(--border-color); cursor: pointer; font-size: 1.5em; line-height: 1; padding: 5px; margin-left: 10px; border-radius: 5px; color: var(--text-color); }
        
        /* FIX: Correct flexbox layout for the comment form */
        #comment-form { display: none; flex-direction: row; gap: 1em; margin-top: 2em; align-items: flex-start; }
        .comment-form-container { position: relative; flex-grow: 1; }
        #comment-form button { flex-shrink: 0; }

        #char-counter { position: absolute; bottom: 5px; right: 10px; font-size: 0.8em; color: #888; }
        textarea { width: 100%; box-sizing: border-box; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.7em; font-size: 1em; min-height: 80px; font-family: "Times New Roman", Times, serif; resize: vertical; }
        h1, h2 { color: var(--text-color); }
        button { background-color: var(--button-bg); color: var(--button-text-color); border: none; cursor: pointer; padding: 0.7em; font-size: 1em; }
        button:hover { background-color: var(--button-hover-bg); }
        .comment { border-bottom: 1px solid var(--border-color); padding: 1em 1em 1em 0; position: relative; }
        .comment.pinned { background-color: var(--pinned-bg); border-left: 4px solid var(--pinned-border); padding-left: 1em; }
        .comment.is-moving { outline: 2px dashed #d9534f; }
        .comment-author { font-weight: bold; color: var(--link-color); margin-bottom: 0.3em; cursor: pointer; }
        .comment-author:hover { text-decoration: underline; }
        .comment-author.banned { text-decoration: line-through; color: #d9534f; }
        .author-nickname { font-style: italic; color: var(--text-color); opacity: 0.8; margin-right: 5px; }
        .comment-date { font-size: 0.8em; color: #888; margin-bottom: 0.5em; }
        .comment-text { line-height: 1.5; white-space: pre-wrap; overflow-wrap: break-word; }
        .comment-text a { color: var(--link-color); }
        .comment-text code { background-color: var(--code-bg); padding: 2px 5px; border-radius: 4px; font-family: monospace; color: var(--text-color); }
        .comment-text pre { display: block; background-color: var(--code-bg); padding: 1em; border-radius: 4px; white-space: pre-wrap; color: var(--text-color); }
        .comment-actions { display: flex; gap: 0.5em; margin-top: 0.5em; align-items: center; flex-wrap: wrap; }
        .comment-actions button { background: none; border: 1px solid var(--border-color); color: var(--text-color); cursor: pointer; padding: 0.3em 0.6em; font-size: 0.8em; border-radius: 4px; }
        .admin-actions-menu { position: relative; display: inline-block; }
        .admin-actions-menu-content { display: none; position: absolute; background-color: var(--container-bg); min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; }
        .admin-actions-menu-content button { width: 100%; text-align: left; padding: 12px 16px; border: none; }
        .admin-actions-menu:hover .admin-actions-menu-content { display: block; }
        .move-target-btn { border: 1px solid #28a745 !important; color: #28a745 !important; margin-left: 10px; }
        .vote-section { display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .vote-btn { font-size: 1.2em; cursor: pointer; border: none; background: none; padding: 2px 5px; border-radius: 4px; color: var(--text-color); }
        .vote-btn.liked { color: #007bff; }
        .vote-btn.disliked { color: #dc3545; }
        .vote-count { font-size: 0.9em; color: #888; }
        .replies-container { margin-left: 2em; border-left: 2px solid var(--border-color); padding-left: 1em; }
        .reply-form { display: none; flex-direction: column; gap: 0.5em; margin-top: 1em; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--container-bg); padding: 2em; border-radius: 5px; width: 90%; max-width: 500px; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 2em; font-weight: bold; cursor: pointer; }
        .modal-content h2 { margin-top: 0; }
        .profile-info p { margin: 0.5em 0; }
        .last-comment { background-color: var(--bg-color); border-left: 3px solid var(--border-color); padding: 1em; margin-top: 1em; }
        #ban-user-btn { background-color: #d9534f; color: white; border: none; padding: 0.8em; margin-top: 1em; cursor: pointer; width: 100%; }
        #ban-user-btn.unban { background-color: #5cb85c; }
        .admin-only { border-top: 1px solid var(--border-color); margin-top: 1em; padding-top: 1em; }
        .admin-only input { width: 100%; box-sizing: border-box; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.5em; }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html">Главная</a>
            <a href="about.html">Об Нас</a>
            <a href="projects.html">Каллы Проект</a>
            <a href="comments.html">Комментарии</a>
            <div class="auth-links">
                <a href="settings.html" id="settingsLink" style="display: none;">Настройки</a>
                <a href="login.html" id="loginLink">Войти</a>
                <a href="register.html" id="registerLink">Регистрация</a>
                <button id="logoutBtn" style="display:none;">Выйти</button>
                <button id="theme-toggle">☀️</button>
            </div>
        </nav>
        <main>
            <h1>Комментарии</h1>
            <div id="admin-panel" style="display: none;">
                <h2>Панель администратора</h2>
                <button id="clear-chat-btn">Очистить все комментарии</button>
                 <div id="move-mode-controls" style="display: none; margin-top: 10px;">
                    <span>Режим перемещения активен.</span>
                    <button id="move-to-root-btn">Сделать главным</button>
                    <button id="cancel-move-btn">Отмена</button>
                </div>
            </div>
            <p id="login-prompt">Пожалуйста, <a href="login.html">войдите</a> или <a href="register.html">зарегистрируйтесь</a>, чтобы оставлять комментарии.</p>
            <form id="comment-form" style="display: none;">
                <div class="comment-form-container">
                    <textarea id="comment-input" placeholder="Введите ваш комментарий... (Поддерживается Markdown)" required maxlength="2000"></textarea>
                    <div id="char-counter">2000</div>
                </div>
                <button type="submit">Отправить</button>
            </form>
            <div id="comments-container"></div>
        </main>
    </div>

    <div class="modal-overlay" id="profile-modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <h2>Данные пользователя</h2>
            <div class="profile-info" id="profile-info-content"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, deleteDoc, updateDoc, getDocs, where, limit, getDoc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from './firebase-config.js';

        const converter = new showdown.Converter({
            simpleLineBreaks: true,
            simplifiedAutoLink: true,
            openLinksInNewWindow: true,
            strikethrough: true,
            tables: true
        });

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const adminEmails = ["Admin@Admin.com", "italy@italy.com"];
        let currentUserIsAdmin = false;
        let currentUser = null;
        let commentBeingMoved = null;
        let bannedUserUIDs = new Set();
        let userProfiles = new Map();

        const loginLink = document.getElementById('loginLink');
        const registerLink = document.getElementById('registerLink');
        const logoutBtn = document.getElementById('logoutBtn');
        const settingsLink = document.getElementById('settingsLink');
        const loginPrompt = document.getElementById('login-prompt');
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');
        const commentsContainer = document.getElementById('comments-container');
        const adminPanel = document.getElementById('admin-panel');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const profileModal = document.getElementById('profile-modal');
        const profileInfoContent = document.getElementById('profile-info-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const moveModeControls = document.getElementById('move-mode-controls');
        const moveToRootBtn = document.getElementById('move-to-root-btn');
        const cancelMoveBtn = document.getElementById('cancel-move-btn');
        const charCounter = document.getElementById('char-counter');
        const MAX_CHARS = 2000;
        const appId = 'default-app-id';

        const commentsRef = collection(db, `/artifacts/${appId}/public/data/comments`);
        const bannedUsersRef = collection(db, `/artifacts/${appId}/public/data/bannedUsers`);
        const userProfilesRef = collection(db, `/artifacts/${appId}/public/data/userProfiles`);
        
        const themeToggle = document.getElementById('theme-toggle');
        const loadTheme = () => {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggle.textContent = '🌙';
            } else {
                document.body.classList.remove('dark-theme');
                themeToggle.textContent = '☀️';
            }
        };
        const saveTheme = (theme) => localStorage.setItem('theme', theme);

        themeToggle.addEventListener('click', () => {
            if (document.body.classList.contains('dark-theme')) {
                document.body.classList.remove('dark-theme');
                saveTheme('light');
                themeToggle.textContent = '☀️';
            } else {
                document.body.classList.add('dark-theme');
                saveTheme('dark');
                themeToggle.textContent = '🌙';
            }
        });
        loadTheme();

        commentInput.addEventListener('input', () => {
            const remaining = MAX_CHARS - commentInput.value.length;
            charCounter.textContent = remaining;
        });
        
        onSnapshot(bannedUsersRef, (snapshot) => {
            bannedUserUIDs.clear();
            snapshot.forEach(doc => bannedUserUIDs.add(doc.id));
        });
        
        onSnapshot(userProfilesRef, (snapshot) => {
            userProfiles.clear();
            snapshot.forEach(doc => userProfiles.set(doc.id, doc.data()));
        });

        onAuthStateChanged(auth, user => {
            currentUser = user;
            currentUserIsAdmin = user && adminEmails.includes(user.email);
            adminPanel.style.display = currentUserIsAdmin ? 'block' : 'none';

            if (user && !user.isAnonymous) {
                loginLink.style.display = 'none';
                registerLink.style.display = 'none';
                logoutBtn.style.display = 'inline';
                settingsLink.style.display = 'inline';
                loginPrompt.style.display = 'none';
                commentForm.style.display = 'flex';
            } else {
                loginLink.style.display = 'inline';
                registerLink.style.display = 'inline';
                logoutBtn.style.display = 'none';
                settingsLink.style.display = 'none';
                loginPrompt.style.display = 'block';
                commentForm.style.display = 'none';
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
        clearChatBtn.addEventListener('click', async () => {
            if (!currentUserIsAdmin || !confirm("ВЫ УВЕРЕНЫ?")) return;
            const snapshot = await getDocs(commentsRef);
            const batch = writeBatch(db);
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        });

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (bannedUserUIDs.has(currentUser?.uid)) {
                alert("Вы забанены и не можете отправлять комментарии.");
                return;
            }
            const commentText = commentInput.value.trim();
            if (currentUser && commentText) {
                await addDoc(commentsRef, {
                    text: commentText, author: currentUser.email, authorUID: currentUser.uid,
                    createdAt: serverTimestamp(), pinned: false, parentId: null,
                    likes: [], dislikes: []
                });
                commentInput.value = '';
                charCounter.textContent = MAX_CHARS;
            }
        });

        modalCloseBtn.addEventListener('click', () => profileModal.style.display = 'none');
        profileModal.addEventListener('click', (e) => { if (e.target === profileModal) profileModal.style.display = 'none'; });

        const showUserProfile = async (userEmail, userUID) => {
            profileInfoContent.innerHTML = '<p>Загрузка данных...</p>';
            profileModal.style.display = 'flex';

            const lastCommentQuery = query(commentsRef, where("authorUID", "==", userUID), orderBy("createdAt", "desc"), limit(1));
            const snapshot = await getDocs(lastCommentQuery);
            let lastCommentHTML = '<p><strong>Последний комментарий:</strong> Нет.</p>';
            if (!snapshot.empty) {
                const lastComment = snapshot.docs[0].data();
                lastCommentHTML = `<p><strong>Последний комментарий:</strong></p><div class="last-comment"><div>${converter.makeHtml(lastComment.text)}</div><small>${lastComment.createdAt ? lastComment.createdAt.toDate().toLocaleString('ru-RU') : ''}</small></div>`;
            }
            let profileHTML = `<p><strong>Email:</strong> ${userEmail}</p>${lastCommentHTML}`;
            if (currentUserIsAdmin) {
                const isBanned = bannedUserUIDs.has(userUID);
                const userProfile = userProfiles.get(userUID) || {};
                const nickname = userProfile.nickname || '';
                profileHTML += `
                    <div class="admin-only">
                        <p><strong>UID:</strong> ${userUID}</p>
                        <p><strong>Статус:</strong> ${isBanned ? '<span style="color:red;">Забанен</span>' : '<span style="color:green;">Активен</span>'}</p>
                        <div>
                            <label for="nickname-input"><strong>Никнейм/Ранг:</strong></label>
                            <input type="text" id="nickname-input" value="${nickname}" placeholder="Например, Модератор">
                            <button id="save-nickname-btn" style="margin-top: 10px;">Сохранить никнейм</button>
                        </div>
                        <button id="ban-user-btn" class="${isBanned ? 'unban' : ''}">${isBanned ? 'Разбанить' : 'Забанить'}</button>
                    </div>`;
            }
            profileInfoContent.innerHTML = profileHTML;
            if (currentUserIsAdmin) {
                document.getElementById('ban-user-btn').onclick = () => toggleBanStatus(userUID, userEmail);
                document.getElementById('save-nickname-btn').onclick = () => saveNickname(userUID);
            }
        };
        
        const toggleBanStatus = async (uid, email) => {
            const isCurrentlyBanned = bannedUserUIDs.has(uid);
            const userDocRef = doc(db, `/artifacts/${appId}/public/data/bannedUsers`, uid);
            if (isCurrentlyBanned) {
                if (confirm(`Разбанить ${email}?`)) await deleteDoc(userDocRef);
            } else {
                if (confirm(`Забанить ${email}?`)) await setDoc(userDocRef, { email: email, bannedAt: serverTimestamp() });
            }
            profileModal.style.display = 'none';
        };

        const saveNickname = async (uid) => {
            const newNickname = document.getElementById('nickname-input').value.trim();
            await setDoc(doc(db, `/artifacts/${appId}/public/data/userProfiles`, uid), { nickname: newNickname }, { merge: true });
            alert("Никнейм сохранен!");
            profileModal.style.display = 'none';
        };
        
        const editComment = async (commentId) => {
            const commentDoc = await getDoc(doc(commentsRef, commentId));
            const newText = prompt("Отредактируйте комментарий:", commentDoc.data().text);
            if (newText !== null) await updateDoc(doc(commentsRef, commentId), { text: newText });
        };

        const handleVote = async (commentId, voteType) => {
            if (!currentUser) return;
            const commentDocRef = doc(commentsRef, commentId);
            const commentSnapshot = await getDoc(commentDocRef);
            if (!commentSnapshot.exists()) return;
            const commentData = commentSnapshot.data();
            let likes = commentData.likes || [];
            let dislikes = commentData.dislikes || [];
            const uid = currentUser.uid;
            const hasLiked = likes.includes(uid);
            const hasDisliked = dislikes.includes(uid);
            if (voteType === 'like') {
                if (hasLiked) { likes = likes.filter(id => id !== uid); } 
                else {
                    likes.push(uid);
                    if (hasDisliked) { dislikes = dislikes.filter(id => id !== uid); }
                }
            } else if (voteType === 'dislike') {
                if (hasDisliked) { dislikes = dislikes.filter(id => id !== uid); } 
                else {
                    dislikes.push(uid);
                    if (hasLiked) { likes = likes.filter(id => id !== uid); }
                }
            }
            await updateDoc(commentDocRef, { likes, dislikes });
        };
        
        const editVotes = async (commentId) => {
            const newLikes = parseInt(prompt("Новое количество лайков:"), 10);
            const newDislikes = parseInt(prompt("Новое количество дизлайков:"), 10);
            if (!isNaN(newLikes) && !isNaN(newDislikes)) {
                await updateDoc(doc(commentsRef, commentId), { 
                    likes: Array.from({ length: newLikes }, (_, i) => `admin_like_${i}`),
                    dislikes: Array.from({ length: newDislikes }, (_, i) => `admin_dislike_${i}`)
                });
            } else { alert("Введите корректные числа."); }
        };

        const enterMoveMode = (comment) => {
            if (commentBeingMoved) exitMoveMode(); 
            commentBeingMoved = comment;
            moveModeControls.style.display = 'block';
            document.querySelectorAll('.comment').forEach(el => {
                if (el.dataset.commentId === comment.id) {
                    el.classList.add('is-moving');
                } else {
                    const moveBtn = document.createElement('button');
                    moveBtn.textContent = 'Переместить сюда';
                    moveBtn.classList.add('move-target-btn');
                    moveBtn.onclick = () => moveComment(comment.id, el.dataset.commentId);
                    el.querySelector('.comment-actions').appendChild(moveBtn);
                }
            });
        };

        const exitMoveMode = () => {
            commentBeingMoved = null;
            moveModeControls.style.display = 'none';
            document.querySelectorAll('.is-moving').forEach(el => el.classList.remove('is-moving'));
            document.querySelectorAll('.move-target-btn').forEach(el => el.remove());
        };

        const moveComment = async (commentToMoveId, newParentId) => {
            await updateDoc(doc(commentsRef, commentToMoveId), { parentId: newParentId });
            exitMoveMode();
        };

        moveToRootBtn.addEventListener('click', () => { if(commentBeingMoved) moveComment(commentBeingMoved.id, null); });
        cancelMoveBtn.addEventListener('click', exitMoveMode);
        
        const renderComments = (comments) => {
            const commentsMap = new Map();
            const rootComments = [];
            comments.forEach(comment => commentsMap.set(comment.id, { ...comment, replies: [] }));
            commentsMap.forEach(comment => {
                if (comment.parentId && commentsMap.has(comment.parentId)) {
                    commentsMap.get(comment.parentId).replies.push(comment);
                } else { rootComments.push(comment); }
            });
            commentsMap.forEach(comment => comment.replies.sort((a, b) => a.createdAt?.toMillis() - b.createdAt?.toMillis()));
            commentsContainer.innerHTML = '';
            rootComments.forEach(comment => commentsContainer.appendChild(createCommentElement(comment)));
            if(commentBeingMoved) enterMoveMode(commentBeingMoved); // Re-apply move mode if it was active
        };

        const createCommentElement = (comment) => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.dataset.commentId = comment.id;
            if (comment.pinned) commentElement.classList.add('pinned');

            const authorElement = document.createElement('div');
            authorElement.className = 'comment-author';
            authorElement.onclick = () => showUserProfile(comment.author, comment.authorUID);
            const nicknameSpan = document.createElement('span');
            nicknameSpan.className = 'author-nickname';
            const userProfile = userProfiles.get(comment.authorUID);
            if(userProfile && userProfile.nickname) nicknameSpan.textContent = `(${userProfile.nickname})`;
            const emailSpan = document.createElement('span');
            emailSpan.textContent = comment.author;
            authorElement.appendChild(nicknameSpan);
            authorElement.appendChild(emailSpan);
            if (bannedUserUIDs.has(comment.authorUID)) authorElement.classList.add('banned');

            const dateElement = document.createElement('div');
            dateElement.className = 'comment-date';
            dateElement.textContent = comment.createdAt ? comment.createdAt.toDate().toLocaleString('ru-RU') : 'Только что';

            const textElement = document.createElement('div');
            textElement.className = 'comment-text';
            const sanitizedText = comment.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            textElement.innerHTML = converter.makeHtml(sanitizedText);

            const actionsElement = document.createElement('div');
            actionsElement.className = 'comment-actions';

            if (currentUser) {
                const replyBtn = document.createElement('button');
                replyBtn.textContent = 'Ответить';
                replyBtn.onclick = () => {
                    const existingForm = commentElement.querySelector('.reply-form');
                    if(existingForm) existingForm.remove();
                    else commentElement.appendChild(createReplyForm(comment.id));
                };
                actionsElement.appendChild(replyBtn);
            }

            if (currentUserIsAdmin) {
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Редактировать';
                editBtn.onclick = () => editComment(comment.id);
                
                const pinBtn = document.createElement('button');
                pinBtn.textContent = comment.pinned ? 'Открепить' : 'Закрепить';
                pinBtn.onclick = () => updateDoc(doc(commentsRef, comment.id), { pinned: !comment.pinned });

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Удалить';
                deleteBtn.onclick = () => { if(confirm("Удалить?")) deleteDoc(doc(commentsRef, comment.id)); };
                
                const adminMenu = document.createElement('div');
                adminMenu.className = 'admin-actions-menu';
                const adminBtn = document.createElement('button');
                adminBtn.textContent = 'Админ';
                const menuContent = document.createElement('div');
                menuContent.className = 'admin-actions-menu-content';
                const editVotesBtn = document.createElement('button');
                editVotesBtn.textContent = 'Изменить голоса';
                editVotesBtn.onclick = () => editVotes(comment.id);
                const moveBtn = document.createElement('button');
                moveBtn.textContent = 'Переместить';
                moveBtn.onclick = () => enterMoveMode(comment);
                menuContent.appendChild(editVotesBtn);
                menuContent.appendChild(moveBtn);
                adminMenu.appendChild(adminBtn);
                adminMenu.appendChild(menuContent);
                
                actionsElement.appendChild(editBtn);
                actionsElement.appendChild(pinBtn);
                actionsElement.appendChild(deleteBtn);
                actionsElement.appendChild(adminMenu);
            }

            const voteSection = document.createElement('div');
            voteSection.className = 'vote-section';
            const likeBtn = document.createElement('button');
            likeBtn.textContent = '👍';
            likeBtn.className = 'vote-btn';
            const likeCount = document.createElement('span');
            likeCount.className = 'vote-count';
            const dislikeBtn = document.createElement('button');
            dislikeBtn.textContent = '👎';
            dislikeBtn.className = 'vote-btn';
            const dislikeCount = document.createElement('span');
            dislikeCount.className = 'vote-count';
            likeCount.textContent = comment.likes?.length || 0;
            dislikeCount.textContent = comment.dislikes?.length || 0;
            if (currentUser) {
                if (comment.likes?.includes(currentUser.uid)) likeBtn.classList.add('liked');
                if (comment.dislikes?.includes(currentUser.uid)) dislikeBtn.classList.add('disliked');
                likeBtn.onclick = () => handleVote(comment.id, 'like');
                dislikeBtn.onclick = () => handleVote(comment.id, 'dislike');
            }
            voteSection.appendChild(likeBtn);
            voteSection.appendChild(likeCount);
            voteSection.appendChild(dislikeBtn);
            voteSection.appendChild(dislikeCount);
            actionsElement.appendChild(voteSection);
            
            commentElement.appendChild(authorElement);
            commentElement.appendChild(dateElement);
            commentElement.appendChild(textElement);
            commentElement.appendChild(actionsElement);

            if (comment.replies && comment.replies.length > 0) {
                const repliesContainer = document.createElement('div');
                repliesContainer.className = 'replies-container';
                comment.replies.forEach(reply => repliesContainer.appendChild(createCommentElement(reply)));
                commentElement.appendChild(repliesContainer);
            }
            return commentElement;
        };

        const createReplyForm = (parentId) => {
            const form = document.createElement('form');
            form.className = 'reply-form';
            form.style.display = 'flex';
            const textarea = document.createElement('textarea');
            textarea.placeholder = 'Введите ваш ответ...';
            textarea.required = true;
            const button = document.createElement('button');
            button.type = 'submit';
            button.textContent = 'Отправить ответ';
            form.appendChild(textarea);
            form.appendChild(button);
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                 if (bannedUserUIDs.has(currentUser?.uid)) {
                    alert("Вы забанены.");
                    return;
                }
                const replyText = textarea.value.trim();
                if (currentUser && replyText) {
                    await addDoc(commentsRef, {
                        text: replyText, author: currentUser.email, authorUID: currentUser.uid,
                        createdAt: serverTimestamp(), pinned: false, parentId: parentId,
                        likes: [], dislikes: []
                    });
                    form.remove();
                }
            });
            return form;
        }

        const commentsQuery = query(commentsRef, orderBy("pinned", "desc"), orderBy("createdAt", "desc"));
        onSnapshot(commentsQuery, (snapshot) => {
            const allComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderComments(allComments);
        }, (error) => {
            console.error("Firestore snapshot error:", error);
        });
    </script>
</body>
</html>




<!-- comments.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Комментарии</title>
    <style>
        body { font-family: "Times New Roman", Times, serif; background-color: #f4f4f4; color: #333; margin: 0; padding: 2em; }
        .container { max-width: 800px; margin: 0 auto; background-color: #ffffff; padding: 2em; border: 1px solid #ddd; }
        nav { padding-bottom: 1em; border-bottom: 1px solid #ddd; margin-bottom: 2em; display: flex; align-items: center; }
        nav a { margin-right: 20px; color: #0056b3; text-decoration: none; font-size: 1.1em; }
        nav a:hover { text-decoration: underline; }
        .auth-links { margin-left: auto; }
        #logoutBtn { background: none; border: none; color: #d9534f; cursor: pointer; font-size: 1.1em; font-family: "Times New Roman", Times, serif; display: none; }
        #logoutBtn:hover { text-decoration: underline; }
        h1 { font-size: 2.5em; font-weight: normal; }
        #comment-form { display: none; flex-direction: column; gap: 1em; margin-top: 2em; }
        textarea { padding: 0.7em; font-size: 1em; border: 1px solid #ccc; min-height: 80px; font-family: "Times New Roman", Times, serif; resize: vertical; }
        #comment-form button { padding: 0.7em; font-size: 1em; background-color: #0056b3; color: white; border: none; cursor: pointer; font-family: "Times New Roman", Times, serif; align-self: flex-start; }
        #comment-form button:hover { background-color: #003d82; }
        #comments-container { margin-top: 2em; border-top: 1px solid #ddd; padding-top: 1em; }
        .comment { border-bottom: 1px solid #eee; padding: 1em; position: relative; transition: background-color: 0.3s; }
        .comment.pinned { background-color: #fffbe6; border-left: 4px solid #f0ad4e; }
        .comment-author { font-weight: bold; color: #0056b3; margin-bottom: 0.3em; }
        .comment-date { font-size: 0.8em; color: #888; margin-bottom: 0.5em; }
        .comment-text { line-height: 1.5; }
        #login-prompt { display: block; margin-top: 2em; font-style: italic; }
        .comment-actions { position: absolute; top: 1em; right: 1em; display: flex; gap: 0.5em; }
        .comment-actions button { background: none; border: 1px solid #ccc; cursor: pointer; padding: 0.3em 0.6em; font-size: 0.8em; border-radius: 4px; }
        .comment-actions .delete-btn:hover { background-color: #fbecec; color: #d9534f; border-color: #d9534f; }
        .comment-actions .pin-btn:hover { background-color: #fcf8e3; color: #8a6d3b; border-color: #8a6d3b; }
        #admin-panel { display: none; background-color: #fbecec; border: 1px solid #d9534f; padding: 1em; margin-bottom: 1em; }
        #admin-panel button { background-color: #d9534f; color: white; border: none; padding: 0.8em 1.2em; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html">Главная</a>
            <a href="about.html">Об Нас</a>
            <a href="projects.html">Каллы Проект</a>
            <a href="comments.html">Комментарии</a>
            <div class="auth-links">
                <a href="login.html" id="loginLink">Войти</a>
                <a href="register.html" id="registerLink">Регистрация</a>
                <button id="logoutBtn">Выйти</button>
            </div>
        </nav>
        <main>
            <h1>Комментарии</h1>

            <div id="admin-panel">
                <h2>Панель администратора</h2>
                <button id="clear-chat-btn">Очистить все комментарии</button>
            </div>

            <p id="login-prompt">Пожалуйста, <a href="login.html">войдите</a> или <a href="register.html">зарегистрируйтесь</a>, чтобы оставлять комментарии.</p>
            
            <form id="comment-form">
                <textarea id="comment-input" placeholder="Введите ваш комментарий..." required></textarea>
                <button type="submit">Отправить</button>
            </form>

            <div id="comments-container">
                <!-- Comments will be loaded here -->
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from './firebase-config.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const adminEmails = ["Admin@Admin.com", "italy@italy.com"];
        let currentUserIsAdmin = false;

        const loginLink = document.getElementById('loginLink');
        const registerLink = document.getElementById('registerLink');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginPrompt = document.getElementById('login-prompt');
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');
        const commentsContainer = document.getElementById('comments-container');
        const adminPanel = document.getElementById('admin-panel');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const appId = 'default-app-id';

        const commentsRef = collection(db, `/artifacts/${appId}/public/data/comments`);

        onAuthStateChanged(auth, user => {
            currentUserIsAdmin = user && adminEmails.includes(user.email);
            adminPanel.style.display = currentUserIsAdmin ? 'block' : 'none';

            if (user && !user.isAnonymous) {
                loginLink.style.display = 'none';
                registerLink.style.display = 'none';
                logoutBtn.style.display = 'inline';
                loginPrompt.style.display = 'none';
                commentForm.style.display = 'flex';
            } else {
                loginLink.style.display = 'inline';
                registerLink.style.display = 'inline';
                logoutBtn.style.display = 'none';
                loginPrompt.style.display = 'block';
                commentForm.style.display = 'none';
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const commentText = commentInput.value.trim();
            if (user && commentText) {
                await addDoc(commentsRef, {
                    text: commentText,
                    author: user.email,
                    createdAt: serverTimestamp(),
                    pinned: false
                });
                commentInput.value = '';
            }
        });

        const deleteComment = async (id) => {
            if (!currentUserIsAdmin || !confirm("Вы уверены, что хотите удалить этот комментарий?")) return;
            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/comments`, id));
        };

        const togglePinComment = async (id, currentState) => {
            if (!currentUserIsAdmin) return;
            await updateDoc(doc(db, `/artifacts/${appId}/public/data/comments`, id), { pinned: !currentState });
        };

        const clearAllComments = async () => {
            if (!currentUserIsAdmin || !confirm("ВЫ УВЕРЕНЫ, ЧТО ХОТИТЕ УДАЛИТЬ ВСЕ КОММЕНТАРИИ? ЭТО ДЕЙСТВИЕ НЕОБРАТИМО.")) return;
            const snapshot = await getDocs(commentsRef);
            snapshot.forEach(doc => deleteDoc(doc.ref));
        };

        clearChatBtn.addEventListener('click', clearAllComments);

        const commentsQuery = query(commentsRef, orderBy("pinned", "desc"), orderBy("createdAt", "desc"));
        onSnapshot(commentsQuery, (snapshot) => {
            commentsContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const comment = { id: doc.id, ...doc.data() };
                const commentElement = document.createElement('div');
                commentElement.classList.add('comment');
                if (comment.pinned) {
                    commentElement.classList.add('pinned');
                }

                const authorElement = document.createElement('div');
                authorElement.classList.add('comment-author');
                authorElement.textContent = comment.author;

                const dateElement = document.createElement('div');
                dateElement.classList.add('comment-date');
                dateElement.textContent = comment.createdAt ? comment.createdAt.toDate().toLocaleString('ru-RU') : 'Только что';

                const textElement = document.createElement('p');
                textElement.classList.add('comment-text');
                textElement.textContent = comment.text;

                commentElement.appendChild(authorElement);
                commentElement.appendChild(dateElement);
                commentElement.appendChild(textElement);

                if (currentUserIsAdmin) {
                    const actionsElement = document.createElement('div');
                    actionsElement.classList.add('comment-actions');

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Удалить';
                    deleteBtn.classList.add('delete-btn');
                    deleteBtn.onclick = () => deleteComment(comment.id);

                    const pinBtn = document.createElement('button');
                    pinBtn.textContent = comment.pinned ? 'Открепить' : 'Закрепить';
                    pinBtn.classList.add('pin-btn');
                    pinBtn.onclick = () => togglePinComment(comment.id, comment.pinned);
                    
                    actionsElement.appendChild(pinBtn);
                    actionsElement.appendChild(deleteBtn);
                    commentElement.appendChild(actionsElement);
                }
                commentsContainer.appendChild(commentElement);
            });
        }, (error) => {
            console.error(error);
            if (error.code === 'failed-precondition') {
                commentsContainer.innerHTML = `<p style="color: red;"><b>Критическая ошибка:</b> Базе данных требуется специальный индекс для сортировки. Откройте консоль разработчика (F12), найдите в ошибке ссылку и перейдите по ней, чтобы создать индекс в вашей Firebase Console.</p>`;
            }
        });
    </script>
</body>
</html>


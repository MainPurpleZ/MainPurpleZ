<!-- comments.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</title>
    <style>
        body { font-family: "Times New Roman", Times, serif; background-color: #f4f4f4; color: #333; margin: 0; padding: 2em; }
        .container { max-width: 800px; margin: 0 auto; background-color: #ffffff; padding: 2em; border: 1px solid #ddd; }
        nav { padding-bottom: 1em; border-bottom: 1px solid #ddd; margin-bottom: 2em; display: flex; align-items: center; }
        nav a { margin-right: 20px; color: #0056b3; text-decoration: none; font-size: 1.1em; }
        nav a:hover { text-decoration: underline; }
        .auth-links { margin-left: auto; }
        #logoutBtn { background: none; border: none; color: #d9534f; cursor: pointer; font-size: 1.1em; font-family: "Times New Roman", Times, serif; display: none; }
        #logoutBtn:hover { text-decoration: underline; }
        h1 { font-size: 2.5em; font-weight: normal; }
        #comment-form { display: none; flex-direction: column; gap: 1em; margin-top: 2em; }
        textarea { padding: 0.7em; font-size: 1em; border: 1px solid #ccc; min-height: 80px; font-family: "Times New Roman", Times, serif; resize: vertical; }
        #comment-form button { padding: 0.7em; font-size: 1em; background-color: #0056b3; color: white; border: none; cursor: pointer; font-family: "Times New Roman", Times, serif; align-self: flex-start; }
        #comment-form button:hover { background-color: #003d82; }
        #comments-container { margin-top: 2em; border-top: 1px solid #ddd; padding-top: 1em; }
        .comment { border-bottom: 1px solid #eee; padding: 1em 1em 1em 0; position: relative; }
        .comment.pinned { background-color: #fffbe6; border-left: 4px solid #f0ad4e; padding-left: 1em; }
        .comment-author { font-weight: bold; color: #0056b3; margin-bottom: 0.3em; }
        .comment-author.admin-clickable { cursor: pointer; text-decoration: underline; }
        .comment-author.admin-clickable:hover { color: #003d82; }
        .comment-date { font-size: 0.8em; color: #888; margin-bottom: 0.5em; }
        .comment-text { line-height: 1.5; white-space: pre-wrap; }
        #login-prompt { display: block; margin-top: 2em; font-style: italic; }
        .comment-actions { display: flex; gap: 0.5em; margin-top: 0.5em; align-items: center; }
        .comment-actions button { background: none; border: 1px solid #ccc; cursor: pointer; padding: 0.3em 0.6em; font-size: 0.8em; border-radius: 4px; }
        .comment-actions .delete-btn:hover { background-color: #fbecec; color: #d9534f; border-color: #d9534f; }
        .comment-actions .pin-btn:hover { background-color: #fcf8e3; color: #8a6d3b; border-color: #8a6d3b; }
        .comment-actions .reply-btn { color: #337ab7; border-color: #337ab7; }
        .comment-actions .reply-btn:hover { background-color: #eaf2fa; }
        #admin-panel { display: none; background-color: #fbecec; border: 1px solid #d9534f; padding: 1em; margin-bottom: 1em; }
        #admin-panel button { background-color: #d9534f; color: white; border: none; padding: 0.8em 1.2em; cursor: pointer; }
        /* Vote Styles */
        .vote-section { display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .vote-btn { font-size: 1.2em; cursor: pointer; border: none; background: none; padding: 2px 5px; border-radius: 4px; transition: transform 0.2s; }
        .vote-btn:hover { transform: scale(1.2); }
        .vote-btn.liked { color: #007bff; }
        .vote-btn.disliked { color: #dc3545; }
        .vote-count { font-size: 0.9em; color: #666; }
        /* Reply Styles */
        .replies-container { margin-left: 2em; border-left: 2px solid #ddd; padding-left: 1em; }
        .reply-form { display: none; flex-direction: column; gap: 0.5em; margin-top: 1em; }
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #fff; padding: 2em; border-radius: 5px; width: 90%; max-width: 500px; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 2em; font-weight: bold; cursor: pointer; }
        .modal-content h2 { margin-top: 0; }
        .profile-info p { margin: 0.5em 0; }
        .profile-info strong { color: #333; }
        .last-comment { background-color: #f9f9f9; border-left: 3px solid #ccc; padding: 1em; margin-top: 1em; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="about.html">–û–± –ù–∞—Å</a>
            <a href="projects.html">–ö–∞–ª–ª—ã –ü—Ä–æ–µ–∫—Ç</a>
            <a href="comments.html">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</a>
            <div class="auth-links">
                <a href="login.html" id="loginLink">–í–æ–π—Ç–∏</a>
                <a href="register.html" id="registerLink">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                <button id="logoutBtn">–í—ã–π—Ç–∏</button>
            </div>
        </nav>
        <main>
            <h1>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h1>
            <div id="admin-panel">
                <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <button id="clear-chat-btn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
            </div>
            <p id="login-prompt">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="login.html">–≤–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ <a href="register.html">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.</p>
            <form id="comment-form">
                <textarea id="comment-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
            <div id="comments-container"></div>
        </main>
    </div>

    <!-- User Profile Modal -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <h2>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div class="profile-info" id="profile-info-content"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, deleteDoc, updateDoc, getDocs, where, limit, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from './firebase-config.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const adminEmails = ["Admin@Admin.com", "italy@italy.com"];
        let currentUserIsAdmin = false;
        let currentUser = null;

        const loginLink = document.getElementById('loginLink');
        const registerLink = document.getElementById('registerLink');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginPrompt = document.getElementById('login-prompt');
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');
        const commentsContainer = document.getElementById('comments-container');
        const adminPanel = document.getElementById('admin-panel');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const profileModal = document.getElementById('profile-modal');
        const profileInfoContent = document.getElementById('profile-info-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const appId = 'default-app-id';

        const commentsRef = collection(db, `/artifacts/${appId}/public/data/comments`);

        onAuthStateChanged(auth, user => {
            currentUser = user;
            currentUserIsAdmin = user && adminEmails.includes(user.email);
            adminPanel.style.display = currentUserIsAdmin ? 'block' : 'none';

            if (user && !user.isAnonymous) {
                loginLink.style.display = 'none';
                registerLink.style.display = 'none';
                logoutBtn.style.display = 'inline';
                loginPrompt.style.display = 'none';
                commentForm.style.display = 'flex';
            } else {
                loginLink.style.display = 'inline';
                registerLink.style.display = 'inline';
                logoutBtn.style.display = 'none';
                loginPrompt.style.display = 'block';
                commentForm.style.display = 'none';
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const commentText = commentInput.value.trim();
            if (currentUser && commentText) {
                await addDoc(commentsRef, {
                    text: commentText,
                    author: currentUser.email,
                    authorUID: currentUser.uid,
                    createdAt: serverTimestamp(),
                    pinned: false,
                    parentId: null, // Top-level comment
                    likes: [],
                    dislikes: []
                });
                commentInput.value = '';
            }
        });

        const clearAllComments = async () => {
            if (!currentUserIsAdmin || !confirm("–í–´ –£–í–ï–†–ï–ù–´, –ß–¢–û –•–û–¢–ò–¢–ï –£–î–ê–õ–ò–¢–¨ –í–°–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò? –≠–¢–û –î–ï–ô–°–¢–í–ò–ï –ù–ï–û–ë–†–ê–¢–ò–ú–û.")) return;
            const snapshot = await getDocs(commentsRef);
            snapshot.forEach(doc => deleteDoc(doc.ref));
        };

        clearChatBtn.addEventListener('click', clearAllComments);
        
        modalCloseBtn.addEventListener('click', () => profileModal.style.display = 'none');
        profileModal.addEventListener('click', (e) => { if (e.target === profileModal) profileModal.style.display = 'none'; });

        const showUserProfile = async (userEmail) => {
            if (!currentUserIsAdmin) return;
            profileInfoContent.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>';
            profileModal.style.display = 'flex';
            let creationTimeText = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ (–º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞)';
             if (auth.currentUser && auth.currentUser.email === userEmail) {
                creationTimeText = auth.currentUser.metadata.creationTime ? new Date(auth.currentUser.metadata.creationTime).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
            const lastCommentQuery = query(commentsRef, where("author", "==", userEmail), orderBy("createdAt", "desc"), limit(1));
            const snapshot = await getDocs(lastCommentQuery);
            let lastCommentHTML = '<p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –æ—Å—Ç–∞–≤–ª—è–ª –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</p>';
            if (!snapshot.empty) {
                const lastComment = snapshot.docs[0].data();
                lastCommentHTML = `<p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong></p><div class="last-comment"><p>${lastComment.text}</p><small>${lastComment.createdAt ? lastComment.createdAt.toDate().toLocaleString('ru-RU') : ''}</small></div>`;
            }
            profileInfoContent.innerHTML = `<p><strong>Email:</strong> ${userEmail}</p><p><strong>–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω:</strong> ${creationTimeText}</p>${lastCommentHTML}`;
        };

        const handleVote = async (commentId, voteType) => {
            if (!currentUser) return;
            const commentDocRef = doc(db, `/artifacts/${appId}/public/data/comments`, commentId);
            const commentSnapshot = await getDoc(commentDocRef);
            if (!commentSnapshot.exists()) return;

            const commentData = commentSnapshot.data();
            const likes = commentData.likes || [];
            const dislikes = commentData.dislikes || [];
            const uid = currentUser.uid;

            const hasLiked = likes.includes(uid);
            const hasDisliked = dislikes.includes(uid);

            if (voteType === 'like') {
                if (hasLiked) {
                    // Unlike
                    likes.splice(likes.indexOf(uid), 1);
                } else {
                    // Like
                    likes.push(uid);
                    if (hasDisliked) {
                        dislikes.splice(dislikes.indexOf(uid), 1);
                    }
                }
            } else if (voteType === 'dislike') {
                if (hasDisliked) {
                    // Undislike
                    dislikes.splice(dislikes.indexOf(uid), 1);
                } else {
                    // Dislike
                    dislikes.push(uid);
                    if (hasLiked) {
                        likes.splice(likes.indexOf(uid), 1);
                    }
                }
            }
            await updateDoc(commentDocRef, { likes, dislikes });
        };


        const renderComments = (comments) => {
            const commentsMap = new Map();
            const rootComments = [];
            comments.forEach(comment => commentsMap.set(comment.id, { ...comment, replies: [] }));
            commentsMap.forEach(comment => {
                if (comment.parentId && commentsMap.has(comment.parentId)) {
                    commentsMap.get(comment.parentId).replies.push(comment);
                } else {
                    rootComments.push(comment);
                }
            });
            commentsMap.forEach(comment => comment.replies.sort((a, b) => a.createdAt?.toMillis() - b.createdAt?.toMillis()));
            commentsContainer.innerHTML = '';
            rootComments.forEach(comment => commentsContainer.appendChild(createCommentElement(comment)));
        };

        const createCommentElement = (comment) => {
            const commentElement = document.createElement('div');
            commentElement.classList.add('comment');
            if (comment.pinned) commentElement.classList.add('pinned');

            const authorElement = document.createElement('div');
            authorElement.classList.add('comment-author');
            authorElement.textContent = comment.author;
            if (currentUserIsAdmin) {
                authorElement.classList.add('admin-clickable');
                authorElement.onclick = () => showUserProfile(comment.author);
            }

            const dateElement = document.createElement('div');
            dateElement.classList.add('comment-date');
            dateElement.textContent = comment.createdAt ? comment.createdAt.toDate().toLocaleString('ru-RU') : '–¢–æ–ª—å–∫–æ —á—Ç–æ';

            const textElement = document.createElement('p');
            textElement.classList.add('comment-text');
            textElement.textContent = comment.text;

            const actionsElement = document.createElement('div');
            actionsElement.classList.add('comment-actions');

            if (currentUser) {
                const replyBtn = document.createElement('button');
                replyBtn.textContent = '–û—Ç–≤–µ—Ç–∏—Ç—å';
                replyBtn.classList.add('reply-btn');
                replyBtn.onclick = () => {
                    const existingForm = commentElement.querySelector('.reply-form');
                    if(existingForm) existingForm.remove();
                    else commentElement.appendChild(createReplyForm(comment.id));
                };
                actionsElement.appendChild(replyBtn);
            }

            if (currentUserIsAdmin) {
                const pinBtn = document.createElement('button');
                pinBtn.textContent = comment.pinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
                pinBtn.classList.add('pin-btn');
                pinBtn.onclick = () => updateDoc(doc(db, `/artifacts/${appId}/public/data/comments`, comment.id), { pinned: !comment.pinned });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                deleteBtn.classList.add('delete-btn');
                deleteBtn.onclick = () => {
                    if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?")) deleteDoc(doc(db, `/artifacts/${appId}/public/data/comments`, comment.id));
                };
                actionsElement.appendChild(pinBtn);
                actionsElement.appendChild(deleteBtn);
            }

            // Vote Section
            const voteSection = document.createElement('div');
            voteSection.classList.add('vote-section');
            const likeBtn = document.createElement('button');
            likeBtn.textContent = 'üëç';
            likeBtn.classList.add('vote-btn', 'like-btn');
            const likeCount = document.createElement('span');
            likeCount.classList.add('vote-count');
            const dislikeBtn = document.createElement('button');
            dislikeBtn.textContent = 'üëé';
            dislikeBtn.classList.add('vote-btn', 'dislike-btn');
            const dislikeCount = document.createElement('span');
            dislikeCount.classList.add('vote-count');

            likeCount.textContent = comment.likes?.length || 0;
            dislikeCount.textContent = comment.dislikes?.length || 0;

            if (currentUser) {
                if (comment.likes?.includes(currentUser.uid)) likeBtn.classList.add('liked');
                if (comment.dislikes?.includes(currentUser.uid)) dislikeBtn.classList.add('disliked');
                likeBtn.onclick = () => handleVote(comment.id, 'like');
                dislikeBtn.onclick = () => handleVote(comment.id, 'dislike');
            } else {
                likeBtn.disabled = true;
                dislikeBtn.disabled = true;
            }

            voteSection.appendChild(likeBtn);
            voteSection.appendChild(likeCount);
            voteSection.appendChild(dislikeBtn);
            voteSection.appendChild(dislikeCount);
            actionsElement.appendChild(voteSection);
            
            commentElement.appendChild(authorElement);
            commentElement.appendChild(dateElement);
            commentElement.appendChild(textElement);
            commentElement.appendChild(actionsElement);

            if (comment.replies && comment.replies.length > 0) {
                const repliesContainer = document.createElement('div');
                repliesContainer.classList.add('replies-container');
                comment.replies.forEach(reply => repliesContainer.appendChild(createCommentElement(reply)));
                commentElement.appendChild(repliesContainer);
            }
            return commentElement;
        };

        const createReplyForm = (parentId) => {
            const form = document.createElement('form');
            form.classList.add('reply-form');
            form.style.display = 'flex';
            const textarea = document.createElement('textarea');
            textarea.placeholder = '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç...';
            textarea.required = true;
            const button = document.createElement('button');
            button.type = 'submit';
            button.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç';
            form.appendChild(textarea);
            form.appendChild(button);
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const replyText = textarea.value.trim();
                if (currentUser && replyText) {
                    await addDoc(commentsRef, {
                        text: replyText,
                        author: currentUser.email,
                        authorUID: currentUser.uid,
                        createdAt: serverTimestamp(),
                        pinned: false,
                        parentId: parentId,
                        likes: [],
                        dislikes: []
                    });
                    form.remove();
                }
            });
            return form;
        }

        const commentsQuery = query(commentsRef, orderBy("pinned", "desc"), orderBy("createdAt", "desc"));
        onSnapshot(commentsQuery, (snapshot) => {
            const allComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderComments(allComments);
        }, (error) => {
            console.error("Firestore snapshot error:", error);
            if (error.code === 'failed-precondition') {
                commentsContainer.innerHTML = `<p style="color: red;"><b>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:</b> –ë–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12), –Ω–∞–π–¥–∏—Ç–µ –≤ –æ—à–∏–±–∫–µ —Å—Å—ã–ª–∫—É –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –Ω–µ–π, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤ –≤–∞—à–µ–π Firebase Console.</p>`;
            }
        });
    </script>
</body>
</html>

